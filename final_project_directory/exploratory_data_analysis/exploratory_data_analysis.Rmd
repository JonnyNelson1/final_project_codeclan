---
title: "Exploratory Data Analysis"
author: "Jonny Nelson"
date: "08/02/2022"
output: html_document
---

# Who is likely to default on their loan?

## Loading in the packages and data

```{r}
library(janitor)
library(tidyverse)
library(here)

loans_clean <- read_csv(here("clean_data/loans_clean.csv"))
head(loans_clean)
```


# Initial Exploration of the Response Variable - loan_status

```{r}
# Description of each loan_status obtained from Lending Club website
description <- c("Loan has been fully paid off.", "Loan for which there is no longer a reasonable expectation of further payments.", "While the loan was paid off, the loan application today would no longer meet the credit policy and wouldn't be approved on to the marketplace.", "While the loan was charged off, the loan application today would no longer meet the credit policy and wouldn't be approved on to the marketplace.", "Loan is up to date on current payments.", "The loan is past due but still in the grace period of 15 days.", "Loan hasn't been paid in 31 to 120 days (late on the current payment).", 
"Loan hasn't been paid in 16 to 30 days (late on the current payment).", 
"Loan is defaulted on and no payment has been made for more than 121 days.")

# Looking at the loan_status unique variables
loan_status <- loans_clean %>%
                group_by(loan_status) %>%
                summarise(count = n())

# Obtain a new data frame to join to the summarized data frame
loans_status_name <- loan_status[,1, drop = FALSE]
loans_description <- data.frame(loans_status_name, description)

left_join(loan_status, loans_description, by = "loan_status")
```

**Who is likely to default**
<br>
* Our data set above is for loans that have been approved and have received funding from investors.3
* Only loan status's that read "Charged Off" and "Fully Paid" can be counted as fully matured loans.
* The "Default" observation is indicative of a loan that has been charged off, however there is a chance that the borrower may still pay it off.
* All other observations are indicative of loans that have not come to maturity.
* Therefore, all analysis will be carried out with a binary response variable.

## Filtering where the loan_status is "Charged Off" or "Fully Paid"

```{r}
lc_loans <- loans_clean %>%
  filter(loan_status %in% c("Charged Off", "Fully Paid"))

# Check that the correct number of observations are given back (33586 + 5653)
```

## Visualising Loan Status

```{r}
percentages <- lc_loans %>%
  group_by(loan_status) %>%
  summarise(count = n(),
            percentage = (count / nrow(lc_loans))*100) %>%
  mutate_if(is_numeric, ~round(., 2)) 
  
  
lc_loans %>%
  ggplot(aes(x = loan_status, fill = loan_status)) +
  geom_bar() + 
  xlab("Loan Status") +
  ylab("Count") +
  ggtitle("Count for Loan Status") +
  guides(fill = guide_legend(title = "Loan Status")) 
  # scale_y_continuous(labels = scales::percent)

# 14.41 85.59
```

* Of the remaining loan_status observations, 85.59% are "Fully Paid" and 14.41% are "Charged Off". This is actually a fairly high default rate if for investors looking to make a return. 

* How do these loans stratify by grade, sub-grade, term, interest rate?
* How much is paid back before the borrower is charged off?

```{r}
ggplot(lc_loans) +
  geom_histogram(aes(x = grade, fill = loan_status),
                 stat = "count",
                 position = "dodge") 
```


```{r}
ggplot(lc_loans) +
  geom_histogram(aes(x = sub_grade, fill = loan_status),
                 stat = "count",
                 position = "dodge") +
  theme(axis.text = element_text(size = 7), text = element_text(size = 11)) +
  ggtitle("Histogram of the Borrowers by Sub-Grade")
```
**Do Statistical Analysis of the distributions**

* Very different distributions here.
* The "Fully Paid" distribution is a right skewed distribution. The majority of the loans in this distribution are found in the grade B, A then C.
* The "Charged Off" distribution is a bi-modal distribution, which is a lot flatter therefore has a wider standard deviation. The majority of the loans in this distribution are found in the grade B, C then D.

```{r}
lc_loans %>%
  ggplot(aes(x = loan_status, fill = term)) +
  geom_bar() + 
  xlab("Loan Status") +
  ylab("Count") +
  ggtitle("Count for Loan Status") +
  guides(fill = guide_legend(title = "Term Length")) 
  # scale_y_continuous(labels = scales::percent)
```

* Very stark split between loan_status based on the term.
* Loans made with a repayment period of 36 months are far more likely to be paid back, compared to loans of a 60 months term.
* Our data goes over the great financial crisis, so it is likely that some of the longer term loans are implicated by this fact.
* If I take the issue date for the loan along with term length, I can analyse the range of the repayment period. 

```{r}
lc_loans
```



